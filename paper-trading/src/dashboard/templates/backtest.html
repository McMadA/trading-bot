<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtesting - Paper Trading</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <header class="header">
        <h1>Backtesting</h1>
        <div class="header-info">
            <a href="/" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </header>

    <div class="container">
        <!-- Backtest Form -->
        <section class="section">
            <h2>Configure Backtest</h2>
            <div class="backtest-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Strategy</label>
                        <select id="bt-strategy">
                            <option value="ema_sma_crossover">EMA/SMA Crossover</option>
                            <option value="rsi">RSI</option>
                            <option value="combined">Combined</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Timeframe</label>
                        <select id="bt-timeframe">
                            <option value="5m">5 minutes</option>
                            <option value="15m" selected>15 minutes</option>
                            <option value="1h">1 hour</option>
                            <option value="4h">4 hours</option>
                            <option value="1d">1 day</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Days</label>
                        <input type="number" id="bt-days" value="30" min="1" max="365">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>Symbols (comma-separated)</label>
                        <input type="text" id="bt-symbols" value="BTC/USDT" placeholder="BTC/USDT, ETH/USDT">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Initial Balance ($)</label>
                        <input type="number" id="bt-initial-balance" value="10000" min="100" step="100">
                    </div>
                </div>

                <!-- Risk Management -->
                <div class="form-row sweep-param-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Stop Loss %</label>
                        <div class="param-input-row">
                            <input type="number" id="bt-stop-loss" value="3" class="param-single" min="0.1" max="50" step="0.1">
                            <label class="sweep-toggle">
                                <input type="checkbox" class="sweep-check" data-key="stop_loss_pct"
                                       onchange="toggleSweep('stop_loss_pct'); updateComboCount();">
                                Sweep
                            </label>
                        </div>
                    </div>
                    <div class="form-group sweep-range" id="sweep-stop_loss_pct" style="display:none; flex: 2;">
                        <label>Range (Min / Max / Step)</label>
                        <div class="sweep-range-inputs">
                            <input type="number" class="sweep-min" id="sweep-min-stop_loss_pct" value="1" placeholder="Min" onchange="updateComboCount()">
                            <span class="sweep-label">to</span>
                            <input type="number" class="sweep-max" id="sweep-max-stop_loss_pct" value="5" placeholder="Max" onchange="updateComboCount()">
                            <span class="sweep-label">step</span>
                            <input type="number" class="sweep-step" id="sweep-step-stop_loss_pct" value="0.5" placeholder="Step" onchange="updateComboCount()">
                        </div>
                    </div>
                </div>

                <div class="form-row sweep-param-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Take Profit %</label>
                        <div class="param-input-row">
                            <input type="number" id="bt-take-profit" value="6" class="param-single" min="0.1" max="100" step="0.1">
                            <label class="sweep-toggle">
                                <input type="checkbox" class="sweep-check" data-key="take_profit_pct"
                                       onchange="toggleSweep('take_profit_pct'); updateComboCount();">
                                Sweep
                            </label>
                        </div>
                    </div>
                    <div class="form-group sweep-range" id="sweep-take_profit_pct" style="display:none; flex: 2;">
                        <label>Range (Min / Max / Step)</label>
                        <div class="sweep-range-inputs">
                            <input type="number" class="sweep-min" id="sweep-min-take_profit_pct" value="2" placeholder="Min" onchange="updateComboCount()">
                            <span class="sweep-label">to</span>
                            <input type="number" class="sweep-max" id="sweep-max-take_profit_pct" value="10" placeholder="Max" onchange="updateComboCount()">
                            <span class="sweep-label">step</span>
                            <input type="number" class="sweep-step" id="sweep-step-take_profit_pct" value="1" placeholder="Step" onchange="updateComboCount()">
                        </div>
                    </div>
                </div>

                <!-- Strategy-specific params with sweep toggles -->
                <div id="bt-strategy-params"></div>

                <div class="form-row" style="align-items: center;">
                    <button onclick="handleRun()" class="btn btn-primary" id="bt-run-btn">Run Backtest</button>
                    <span id="bt-loading" style="display:none; margin-left: 1rem; color: var(--text-secondary);">Starting...</span>
                    <span id="bt-combo-count" style="margin-left: 1rem; font-size: 0.85rem; color: var(--text-secondary);"></span>
                </div>

                <div id="bt-progress-container" style="display:none; width: 100%; margin-top: 1rem;">
                    <div style="width: 100%; background-color: #2a2a4e; border-radius: 4px; overflow: hidden;">
                        <div id="bt-progress-bar" style="width: 0%; height: 20px; background-color: #00d4aa; transition: width 0.3s ease;"></div>
                    </div>
                    <div id="bt-progress-text" style="text-align: center; font-size: 0.85rem; color: #e0e0e0; margin-top: 0.5rem;">0%</div>
                </div>
            </div>
        </section>

        <!-- Single Run Results -->
        <section class="section" id="bt-results" style="display:none;">
            <h2>Latest Run Results</h2>
            <div class="cards">
                <div class="card">
                    <div class="card-label">Total Return</div>
                    <div class="card-value" id="bt-return">0%</div>
                </div>
                <div class="card">
                    <div class="card-label">Win Rate</div>
                    <div class="card-value" id="bt-winrate">0%</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Trades</div>
                    <div class="card-value" id="bt-trades">0</div>
                </div>
                <div class="card">
                    <div class="card-label">Max Drawdown</div>
                    <div class="card-value" id="bt-drawdown">0%</div>
                </div>
            </div>

            <h3>Equity Curve</h3>
            <div id="bt-equity-chart"></div>

            <h3>Trade List</h3>
            <div class="table-wrapper">
                <table id="bt-trades-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Entry</th>
                            <th>Exit</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Comparison Table -->
        <section class="section" id="bt-comparison-section" style="display:none;">
            <div class="section-header">
                <h2 style="margin-bottom:0;">Comparison Table</h2>
                <button onclick="clearComparison()" class="btn btn-secondary btn-small">Clear All</button>
            </div>
            <div class="table-wrapper">
                <table id="bt-comparison-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-key="run">#</th>
                            <th class="sortable" data-key="strategy">Strategy</th>
                            <th class="sortable" data-key="params">Parameters</th>
                            <th class="sortable" data-key="total_return_pct">Return %</th>
                            <th class="sortable" data-key="win_rate">Win Rate</th>
                            <th class="sortable" data-key="total_trades">Trades</th>
                            <th class="sortable" data-key="max_drawdown_pct">Max DD</th>
                            <th class="sortable" data-key="avg_trade_pnl">Avg P&L</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // ==================== CONSTANTS ====================

        const STRATEGY_PARAMS = {
            ema_sma_crossover: [
                {key: "ema_period", label: "EMA Period", default: 10, sweepMin: 5, sweepMax: 50, sweepStep: 5},
                {key: "sma_period", label: "SMA Period", default: 20, sweepMin: 10, sweepMax: 100, sweepStep: 10},
            ],
            rsi: [
                {key: "period", label: "RSI Period", default: 14, sweepMin: 5, sweepMax: 30, sweepStep: 1},
                {key: "overbought", label: "Overbought", default: 70, sweepMin: 60, sweepMax: 85, sweepStep: 5},
                {key: "oversold", label: "Oversold", default: 30, sweepMin: 15, sweepMax: 40, sweepStep: 5},
            ],
            combined: [
                {key: "ema_period", label: "EMA Period", default: 10, sweepMin: 5, sweepMax: 50, sweepStep: 5},
                {key: "sma_period", label: "SMA Period", default: 20, sweepMin: 10, sweepMax: 100, sweepStep: 10},
                {key: "rsi_period", label: "RSI Period", default: 14, sweepMin: 5, sweepMax: 30, sweepStep: 1},
                {key: "rsi_overbought", label: "RSI Overbought", default: 70, sweepMin: 60, sweepMax: 85, sweepStep: 5},
                {key: "rsi_oversold", label: "RSI Oversold", default: 30, sweepMin: 15, sweepMax: 40, sweepStep: 5},
            ],
        };

        const PLOTLY_LAYOUT = {
            paper_bgcolor: "#1a1a2e",
            plot_bgcolor: "#16213e",
            font: {color: "#e0e0e0", size: 11},
            margin: {t: 20, b: 40, l: 60, r: 20},
            xaxis: {gridcolor: "#2a2a4e"},
            yaxis: {gridcolor: "#2a2a4e", title: "Portfolio Value ($)"},
        };

        // ==================== STATE ====================

        let comparisonResults = [];
        let runCounter = 0;
        let currentSort = {key: "run", asc: false};

        // ==================== INIT ====================

        document.getElementById("bt-strategy").addEventListener("change", updateBtParams);
        updateBtParams();

        // ==================== PARAMETER UI ====================

        function updateBtParams() {
            const strategy = document.getElementById("bt-strategy").value;
            const params = STRATEGY_PARAMS[strategy] || [];
            const container = document.getElementById("bt-strategy-params");

            container.innerHTML = params.map(p => `
                <div class="form-row sweep-param-row">
                    <div class="form-group" style="flex: 1;">
                        <label>${p.label}</label>
                        <div class="param-input-row">
                            <input type="number" id="bt-param-${p.key}" value="${p.default}" class="param-single">
                            <label class="sweep-toggle">
                                <input type="checkbox" class="sweep-check" data-key="${p.key}"
                                       onchange="toggleSweep('${p.key}'); updateComboCount();">
                                Sweep
                            </label>
                        </div>
                    </div>
                    <div class="form-group sweep-range" id="sweep-${p.key}" style="display:none; flex: 2;">
                        <label>Range</label>
                        <div class="sweep-range-inputs">
                            <input type="number" class="sweep-min" id="sweep-min-${p.key}" value="${p.sweepMin}" placeholder="Min" onchange="updateComboCount()">
                            <span class="sweep-label">to</span>
                            <input type="number" class="sweep-max" id="sweep-max-${p.key}" value="${p.sweepMax}" placeholder="Max" onchange="updateComboCount()">
                            <span class="sweep-label">step</span>
                            <input type="number" class="sweep-step" id="sweep-step-${p.key}" value="${p.sweepStep}" placeholder="Step" onchange="updateComboCount()">
                        </div>
                    </div>
                </div>
            `).join("");

            updateComboCount();
        }

        function toggleSweep(key) {
            const rangeEl = document.getElementById("sweep-" + key);
            const check = document.querySelector(`.sweep-check[data-key="${key}"]`);
            rangeEl.style.display = check.checked ? "block" : "none";
        }

        function getActiveSweeps() {
            const sweeps = {};
            document.querySelectorAll(".sweep-check:checked").forEach(cb => {
                const key = cb.dataset.key;
                const min = parseFloat(document.getElementById("sweep-min-" + key).value);
                const max = parseFloat(document.getElementById("sweep-max-" + key).value);
                const step = parseFloat(document.getElementById("sweep-step-" + key).value);
                if (step > 0 && min <= max) {
                    let count = 0;
                    for (let v = min; v <= max + 1e-9; v += step) count++;
                    sweeps[key] = {min, max, step, count};
                }
            });
            return sweeps;
        }

        function updateComboCount() {
            const sweeps = getActiveSweeps();
            const keys = Object.keys(sweeps);
            const btn = document.getElementById("bt-run-btn");
            const countEl = document.getElementById("bt-combo-count");

            if (keys.length === 0) {
                btn.textContent = "Run Backtest";
                countEl.textContent = "";
                return;
            }

            let total = 1;
            keys.forEach(k => total *= sweeps[k].count);
            btn.textContent = "Run Sweep (" + total + " combinations)";
            countEl.textContent = keys.map(k => k + ": " + sweeps[k].count + " values").join(", ");
        }

        // ==================== COMMON HELPERS ====================

        function getFormData() {
            const strategy = document.getElementById("bt-strategy").value;
            const symbols = document.getElementById("bt-symbols").value
                .split(",").map(s => s.trim()).filter(s => s);
            const timeframe = document.getElementById("bt-timeframe").value;
            const days = parseInt(document.getElementById("bt-days").value);
            const initialBalance = parseFloat(document.getElementById("bt-initial-balance").value);
            const stopLoss = parseFloat(document.getElementById("bt-stop-loss").value) / 100;
            const takeProfit = parseFloat(document.getElementById("bt-take-profit").value) / 100;

            const params = {};
            (STRATEGY_PARAMS[strategy] || []).forEach(p => {
                const el = document.getElementById("bt-param-" + p.key);
                if (el) params[p.key] = parseFloat(el.value);
            });

            return {strategy, symbols, timeframe, days, initialBalance, stopLoss, takeProfit, params};
        }

        function setLoading(on) {
            const btn = document.getElementById("bt-run-btn");
            const loading = document.getElementById("bt-loading");
            btn.disabled = on;
            loading.style.display = on ? "inline" : "none";
        }

        // ==================== RUN HANDLER ====================

        function handleRun() {
            const sweeps = getActiveSweeps();
            if (Object.keys(sweeps).length > 0) {
                runSweep(sweeps);
            } else {
                runBacktest();
            }
        }

        // ==================== SINGLE BACKTEST ====================

        async function runBacktest(overrideParams) {
            setLoading(true);
            const form = getFormData();
            const params = overrideParams || form.params;

            try {
                // Start backtest
                const resp = await fetch("/api/backtest", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        strategy: form.strategy,
                        params: params,
                        symbols: form.symbols,
                        timeframe: form.timeframe,
                        days: form.days,
                        initial_balance: form.initialBalance,
                        stop_loss_pct: form.stopLoss,
                        take_profit_pct: form.takeProfit,
                    }),
                });

                const startData = await resp.json();
                if (!resp.ok) {
                    throw new Error(startData.error || "Failed to start backtest");
                }

                // Poll for completion
                await pollTask(startData.task_id, (result) => {
                    displayResults(result);
                    addToComparison({
                        strategy: form.strategy,
                        params: params,
                        total_return_pct: result.total_return_pct,
                        win_rate: result.win_rate,
                        total_trades: result.total_trades,
                        max_drawdown_pct: result.max_drawdown_pct,
                        avg_trade_pnl: result.avg_trade_pnl,
                    });
                });

            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                setLoading(false);
            }
        }

        // ==================== SWEEP ====================

        async function runSweep(sweeps) {
            setLoading(true);
            const form = getFormData();

            // Build param_ranges and base_params
            const paramRanges = {};
            const baseParams = {};
            const strategy = form.strategy;

            // Strategy params
            (STRATEGY_PARAMS[strategy] || []).forEach(p => {
                if (sweeps[p.key]) {
                    paramRanges[p.key] = {
                        min: sweeps[p.key].min,
                        max: sweeps[p.key].max,
                        step: sweeps[p.key].step,
                    };
                } else {
                    const el = document.getElementById("bt-param-" + p.key);
                    if (el) baseParams[p.key] = parseFloat(el.value);
                }
            });

            // Risk params (SL/TP)
            ["stop_loss_pct", "take_profit_pct"].forEach(key => {
                if (sweeps[key]) {
                    // Convert percentage to decimal
                    paramRanges[key] = {
                        min: sweeps[key].min / 100,
                        max: sweeps[key].max / 100,
                        step: sweeps[key].step / 100,
                    };
                }
            });

            try {
                // Start sweep
                const resp = await fetch("/api/backtest/sweep", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        strategy: strategy,
                        symbols: form.symbols,
                        timeframe: form.timeframe,
                        days: form.days,
                        initial_balance: form.initialBalance,
                        stop_loss_pct: form.stopLoss,
                        take_profit_pct: form.takeProfit,
                        param_ranges: paramRanges,
                        base_params: baseParams,
                    }),
                });

                const startData = await resp.json();
                if (!resp.ok) {
                    throw new Error(startData.error || "Failed to start sweep");
                }

                // Poll for completion
                await pollTask(startData.task_id, (result) => {
                    // Add all results to comparison table
                    (result.sweep_results || []).forEach(r => {
                        addToComparison({
                            strategy: r.strategy_name || strategy,
                            params: r.params,
                            total_return_pct: r.total_return_pct,
                            win_rate: r.win_rate,
                            total_trades: r.total_trades,
                            max_drawdown_pct: r.max_drawdown_pct,
                            avg_trade_pnl: r.avg_trade_pnl,
                        });
                    });
                    // Scroll to comparison table
                    document.getElementById("bt-comparison-section").scrollIntoView({behavior: "smooth"});
                });

            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                setLoading(false);
            }
        }

        // ==================== POLLING ====================

        async function pollTask(taskId, onComplete) {
            const progressContainer = document.getElementById("bt-progress-container");
            const progressBar = document.getElementById("bt-progress-bar");
            const progressText = document.getElementById("bt-progress-text");

            progressContainer.style.display = "block";
            progressBar.style.width = "0%";
            progressText.textContent = "0%";

            return new Promise((resolve, reject) => {
                const intervalId = setInterval(async () => {
                    try {
                        const resp = await fetch(`/api/backtest/status/${taskId}`);
                        if (!resp.ok) {
                            // If 404, maybe task expired or server restarted?
                            throw new Error("Failed to get task status");
                        }

                        const data = await resp.json();

                        if (data.status === "completed") {
                            clearInterval(intervalId);
                            progressBar.style.width = "100%";
                            progressText.textContent = "100%";
                            setTimeout(() => {
                                progressContainer.style.display = "none";
                                onComplete(data.result);
                                resolve();
                            }, 500); // Short delay to show 100%
                        } else if (data.status === "error") {
                            clearInterval(intervalId);
                            progressContainer.style.display = "none";
                            reject(new Error(data.error_msg || "Unknown error during backtest"));
                        } else {
                            // Running
                            progressBar.style.width = data.progress + "%";
                            progressText.textContent = Math.round(data.progress) + "%";
                        }
                    } catch (e) {
                        clearInterval(intervalId);
                        progressContainer.style.display = "none";
                        reject(e);
                    }
                }, 1000); // Poll every 1 second
            });
        }

        // ==================== DISPLAY SINGLE RESULTS ====================

        function displayResults(data) {
            document.getElementById("bt-results").style.display = "block";

            document.getElementById("bt-return").textContent = data.total_return_pct.toFixed(2) + "%";
            document.getElementById("bt-return").className = "card-value " + (data.total_return_pct >= 0 ? "positive" : "negative");
            document.getElementById("bt-winrate").textContent = data.win_rate.toFixed(1) + "%";
            document.getElementById("bt-trades").textContent = data.total_trades;
            document.getElementById("bt-drawdown").textContent = data.max_drawdown_pct.toFixed(2) + "%";
            document.getElementById("bt-drawdown").className = "card-value negative";

            // Equity curve
            if (data.equity_curve && data.equity_curve.length > 0) {
                Plotly.newPlot("bt-equity-chart", [{
                    x: data.equity_curve.map(p => p.timestamp),
                    y: data.equity_curve.map(p => p.value),
                    type: "scatter",
                    mode: "lines",
                    line: {color: "#00d4aa", width: 2},
                    fill: "tozeroy",
                    fillcolor: "rgba(0, 212, 170, 0.1)",
                }], PLOTLY_LAYOUT, {responsive: true});
            }

            // Trade list
            const tbody = document.querySelector("#bt-trades-table tbody");
            tbody.innerHTML = "";
            (data.trades || []).forEach(t => {
                const pnlClass = t.pnl >= 0 ? "positive" : "negative";
                tbody.innerHTML += `<tr>
                    <td>${t.symbol}</td>
                    <td>${t.side}</td>
                    <td>$${t.entry_price.toFixed(2)}</td>
                    <td>$${t.exit_price.toFixed(2)}</td>
                    <td class="${pnlClass}">$${t.pnl.toFixed(2)}</td>
                    <td class="${pnlClass}">${t.pnl_pct.toFixed(2)}%</td>
                    <td>${t.duration_minutes}m</td>
                </tr>`;
            });
        }

        // ==================== COMPARISON TABLE ====================

        function addToComparison(result) {
            runCounter++;
            result.run = runCounter;
            comparisonResults.push(result);
            renderComparisonTable();
        }

        function renderComparisonTable() {
            const section = document.getElementById("bt-comparison-section");
            section.style.display = "block";

            // Sort
            const sorted = [...comparisonResults].sort((a, b) => {
                const key = currentSort.key;
                let va = key === "params" ? formatParams(a.params) : a[key];
                let vb = key === "params" ? formatParams(b.params) : b[key];
                if (typeof va === "string") {
                    return currentSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                }
                return currentSort.asc ? va - vb : vb - va;
            });

            // Find best return
            let bestIdx = -1;
            let bestReturn = -Infinity;
            sorted.forEach((r, i) => {
                if (r.total_return_pct > bestReturn) {
                    bestReturn = r.total_return_pct;
                    bestIdx = i;
                }
            });

            const tbody = document.querySelector("#bt-comparison-table tbody");
            tbody.innerHTML = "";

            sorted.forEach((r, i) => {
                const returnClass = r.total_return_pct >= 0 ? "positive" : "negative";
                const rowClass = i === bestIdx ? "best-result" : "";
                const paramsStr = formatParams(r.params);
                const paramsJson = JSON.stringify(r.params).replace(/"/g, "&quot;");

                tbody.innerHTML += `<tr class="${rowClass}">
                    <td>${r.run}</td>
                    <td>${formatStrategyName(r.strategy)}</td>
                    <td class="params-cell">${paramsStr}</td>
                    <td class="${returnClass}">${r.total_return_pct.toFixed(2)}%</td>
                    <td>${r.win_rate.toFixed(1)}%</td>
                    <td>${r.total_trades}</td>
                    <td class="negative">${r.max_drawdown_pct.toFixed(2)}%</td>
                    <td>${r.avg_trade_pnl.toFixed(2)}</td>
                    <td><button class="btn btn-secondary btn-small" onclick='runDetailedBacktest(${paramsJson})'>Details</button></td>
                </tr>`;
            });

            // Update sort indicators
            document.querySelectorAll("#bt-comparison-table th.sortable").forEach(th => {
                th.classList.remove("sort-asc", "sort-desc");
                if (th.dataset.key === currentSort.key) {
                    th.classList.add(currentSort.asc ? "sort-asc" : "sort-desc");
                }
            });
        }

        function formatParams(params) {
            if (!params) return "";
            return Object.entries(params).map(([k, v]) => {
                let val = v;
                if (typeof v === 'number') {
                    // Nice formatting for floats
                    val = parseFloat(v.toFixed(6));
                }
                return `<span class="param-tag">${k}=${val}</span>`;
            }).join(" ");
        }

        function formatStrategyName(name) {
            const names = {
                ema_sma_crossover: "EMA/SMA",
                rsi: "RSI",
                combined: "Combined",
            };
            return names[name] || name;
        }

        function clearComparison() {
            comparisonResults = [];
            runCounter = 0;
            document.getElementById("bt-comparison-section").style.display = "none";
        }

        function runDetailedBacktest(params) {
            // Fill in form values from the params
            for (const [key, value] of Object.entries(params)) {
                // Try strategy param ID
                let el = document.getElementById("bt-param-" + key);

                // Try risk param IDs
                if (!el) {
                    if (key === "stop_loss_pct") el = document.getElementById("bt-stop-loss");
                    if (key === "take_profit_pct") el = document.getElementById("bt-take-profit");
                }

                if (el) {
                    // Check if it's a percentage that needs scaling (SL/TP come as decimals like 0.03)
                    if (key === "stop_loss_pct" || key === "take_profit_pct") {
                        el.value = parseFloat((value * 100).toFixed(2));
                    } else {
                        el.value = value;
                    }
                }
            }
            // Run single backtest with those params
            runBacktest(params);
            // Scroll to results
            setTimeout(() => {
                document.getElementById("bt-results").scrollIntoView({behavior: "smooth"});
            }, 200);
        }

        // Sortable column click handler
        document.querySelectorAll("#bt-comparison-table th.sortable").forEach(th => {
            th.addEventListener("click", () => {
                const key = th.dataset.key;
                if (currentSort.key === key) {
                    currentSort.asc = !currentSort.asc;
                } else {
                    currentSort.key = key;
                    currentSort.asc = key === "run" || key === "strategy" || key === "params";
                }
                renderComparisonTable();
            });
        });
    </script>
</body>
</html>
